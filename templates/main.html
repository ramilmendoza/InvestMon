<!-- templates/main.html -->
{% extends "base.html" %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@100;200;300;400;500;600;700&display=swap');
    
    :root {
        --primary: #00f7ff;
        --secondary: #7b2dff;
        --dark: #0a0a1a;
        --light: #e0e0ff;
        --success: #00ff9d;
        --danger: #ff3860;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--dark);
        color: var(--light);
        font-weight: 300;
    }
    
    h1, .modal-title, .card-header {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    .header-gradient {
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 0 8px rgba(123, 45, 255, 0.3);
    }
    
    .date-display {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 400;
        color: var(--primary);
        letter-spacing: 0.5px;
    }
    
    .text-muted-2 {
        color: rgba(200, 200, 255, 0.6) !important;
    }
    
    /* Table Styles */
    .table {
        color: var(--light);
        border-color: #2a2a4a;
    }
    
    .table-light th {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
        background-color: rgba(26, 26, 58, 0.9);
        padding: 1rem 0.75rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }
    
    .table-light th:hover {
        text-shadow: 0 0 8px rgba(0, 247, 255, 0.4);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(123, 45, 255, 0.1);
    }
    
    .table-light {
        background-color: #1a1a3a;
    }
    
    .text-success {
        color: var(--success) !important;
    }
    
    .text-danger {
        color: var(--danger) !important;
    }
    
    .table-active {
        background-color: rgba(123, 45, 255, 0.2) !important;
    }
    
    /* Glass Card */
    .glass-card {
        backdrop-filter: blur(8px);
        background-color: rgba(26, 26, 58, 0.7);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(123, 45, 255, 0.2);
    }
    
    /* Buttons */
    .btn-holographic {
        background: linear-gradient(135deg, rgba(0, 247, 255, 0.2), rgba(123, 45, 255, 0.2));
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-holographic:hover {
        background: linear-gradient(135deg, rgba(0, 247, 255, 0.3), rgba(123, 45, 255, 0.3));
        box-shadow: 0 0 15px rgba(0, 247, 255, 0.3);
    }
    
    /* Form Controls */
    .form-select-glass, .form-control-glass {
        background: rgba(26, 26, 58, 0.7) !important;
        border: 1px solid rgba(123, 45, 255, 0.2) !important;
        color: white !important;
    }
    
    .form-select-glass:focus, .form-control-glass:focus {
        background: rgba(26, 26, 58, 0.9) !important;
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 0.25rem rgba(0, 247, 255, 0.25) !important;
    }
    
    /* Modal */
    .modal-content {
        background-color: #1a1a3a;
        border: 1px solid var(--primary);
    }
    
    /* Watchlist Cards */
    .watchlist-card {
        background: rgba(26, 26, 58, 0.7);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        border: 1px solid rgba(123, 45, 255, 0.2);
    }
    
    .symbol-badge {
        padding: 4px 8px;
        font-size: 0.8rem;
        background: rgba(40, 40, 60, 0.7);
        color: white;
        border-radius: 4px;
    }
    
    /* Sortable headers */
    .sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
    }
    
    .sort-icon {
        margin-left: 5px;
        font-size: 0.7em;
    }
    
    .sort-asc .sort-icon::after {
        content: " ↑";
    }
    
    .sort-desc .sort-icon::after {
        content: " ↓";
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="header-gradient mb-0">PSE STOCK DASHBOARD</h1>
        <div class="date-display">{{ latest_date }}</div>
    </div>

    <div class="row mb-3 align-items-center">
        <div class="col-md-6">
            <p class="text-muted-2 mb-0" style="font-size: 0.85rem;">Latest market data</p>
        </div>
        <div class="col-md-6 text-end d-flex justify-content-end align-items-center">
            <form class="d-flex me-2 align-items-center" id="filterForm" style="height: 32px;">
                <select class="form-select-glass me-2" id="symbolFilter" name="symbol" style="height: 100%; padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                    <option value="">All Symbols</option>
                    {% if portfolio_symbols %}
                    <option value="__MY_PORTFOLIO__" {% if request.args.get('symbol') == '__MY_PORTFOLIO__' %}selected{% endif %}>My Portfolio</option>
                    {% endif %}
                    <optgroup label="Individual Symbols">
                        {% for symbol in symbols %}
                            <option value="{{ symbol }}" {% if request.args.get('symbol') == symbol %}selected{% endif %}>
                                {{ symbol }}
                            </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </form>
            <button class="btn btn-holographic me-2" id="watchlistBtn" data-bs-toggle="modal" data-bs-target="#watchlistModal" 
                    style="height: 32px; padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                <i class="bi bi-bookmark-plus"></i> Watchlist
            </button>
			<a href="{{ url_for('portfolio') }}" class="btn btn-holographic" 
					style="height: 32px; padding: 0.25rem 0.75rem; font-size: 0.85rem;">
				<i class="bi bi-wallet2"></i> Portfolio
			</a>
        </div>
    </div>

    <!-- Watchlist Management Modal -->
    <div class="modal fade" id="watchlistModal" tabindex="-1" aria-labelledby="watchlistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-bottom-primary">
                    <h5 class="modal-title text-primary" id="watchlistModalLabel">Manage Watchlists</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control-glass" id="watchlistName" placeholder="New watchlist name">
                            <button class="btn btn-holographic" id="createWatchlistBtn">Create</button>
                        </div>
                    </div>
                    
                    <div id="watchlistContainer">
                        <!-- Watchlists will be populated here -->
                    </div>
                    
                    <div id="editWatchlistSection" class="mt-3" style="display: none;">
                        <h6 class="text-primary">Edit: <span id="editWatchlistName"></span></h6>
                        <div class="input-group mb-2">
                            <select class="form-select-glass" id="availableSymbols">
                                <option value="">Select symbol to add</option>
                                {% for symbol in symbols %}
                                    <option value="{{ symbol }}">{{ symbol }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-holographic" id="addSymbolBtn">Add</button>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-primary">Symbols in Watchlist:</h6>
                            <div id="currentSymbols" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" id="saveWatchlistBtn">Save</button>
                            <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive glass-card">
        <table class="table table-hover">
            <thead class="table-light sticky-top">
                <tr>
                    <th class="sortable" data-sort="symbol">Symbol <span class="sort-icon">↕</span></th>
                    <th class="sortable" data-sort="change">Change <span class="sort-icon">↕</span></th>
                    <th>Last Price</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Volume</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="stockTableBody">
                {% for stock in stocks %}
                    {% set change = ((stock.close - stock.open) / stock.open * 100) if stock.open and stock.close else 0 %}
                    <tr data-symbol="{{ stock.symbol }}" data-change="{{ change }}">
                        <td class="fw-bold">{{ stock.symbol }}</td>
                        <td class="fw-bold {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-secondary{% endif %}">
                            {% if stock.open and stock.close %}
                                {{ "%+.2f"|format(change) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="fw-medium">{{ "%.2f"|format(stock.close) if stock.close else '-' }}</td>
                        <td>{{ "%.2f"|format(stock.open) if stock.open else '-' }}</td>
                        <td>{{ "%.2f"|format(stock.high) if stock.high else '-' }}</td>
                        <td>{{ "%.2f"|format(stock.low) if stock.low else '-' }}</td>
                        <td>{{ "{:,.0f}".format(stock.volume) if stock.volume else '-' }}</td>
                        <td>
                            <a href="/symbol/{{ stock.symbol }}" class="btn btn-sm btn-holographic" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">View</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const symbolFilter = document.getElementById('symbolFilter');
        const watchlistBtn = document.getElementById('watchlistBtn');
        const watchlistModal = document.getElementById('watchlistModal');
        const watchlistName = document.getElementById('watchlistName');
        const createWatchlistBtn = document.getElementById('createWatchlistBtn');
        const watchlistContainer = document.getElementById('watchlistContainer');
        const editWatchlistSection = document.getElementById('editWatchlistSection');
        const editWatchlistName = document.getElementById('editWatchlistName');
        const availableSymbols = document.getElementById('availableSymbols');
        const addSymbolBtn = document.getElementById('addSymbolBtn');
        const currentSymbols = document.getElementById('currentSymbols');
        const saveWatchlistBtn = document.getElementById('saveWatchlistBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const stockTableBody = document.getElementById('stockTableBody');
        
        // State variables
        let watchlists = JSON.parse(localStorage.getItem('stockWatchlists')) || [];
        let currentEditingWatchlist = null;
        let currentSort = {
            column: null,
            direction: 1 // 1 for ascending, -1 for descending
        };

        // Initialize watchlists in filter dropdown
        updateWatchlistFilter();
        renderWatchlists();
        
        // Create new watchlist
        createWatchlistBtn.addEventListener('click', function() {
            const name = watchlistName.value.trim();
            if (name && !watchlists.some(w => w.name === name)) {
                watchlists.push({
                    name: name,
                    symbols: []
                });
                saveWatchlists();
                renderWatchlists();
                updateWatchlistFilter();
                watchlistName.value = '';
            }
        });
        
        // Edit watchlist symbols
        addSymbolBtn.addEventListener('click', function() {
            if (currentEditingWatchlist !== null) {
                const symbol = availableSymbols.value;
                if (symbol && !watchlists[currentEditingWatchlist].symbols.includes(symbol)) {
                    watchlists[currentEditingWatchlist].symbols.push(symbol);
                    renderCurrentSymbols();
                }
            }
        });
        
        // Save watchlist changes
        saveWatchlistBtn.addEventListener('click', function() {
            if (currentEditingWatchlist !== null) {
                saveWatchlists();
                renderWatchlists();
                updateWatchlistFilter();
                cancelEdit();
                
                // If this watchlist is currently selected, update the view
                if (symbolFilter.value === watchlists[currentEditingWatchlist].name) {
                    filterStocks();
                }
            }
        });
        
        // Cancel edit mode
        cancelEditBtn.addEventListener('click', cancelEdit);
        
        // Filter stocks when dropdown changes
        symbolFilter.addEventListener('change', filterStocks);
        
        // Sort functionality
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortColumn = this.dataset.sort;
                
                if (currentSort.column === sortColumn) {
                    currentSort.direction *= -1;
                } else {
                    currentSort.column = sortColumn;
                    currentSort.direction = 1;
                }
                
                sortableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(currentSort.direction === 1 ? 'sort-asc' : 'sort-desc');
                sortTable();
            });
        });

        // Functions
        function saveWatchlists() {
            localStorage.setItem('stockWatchlists', JSON.stringify(watchlists));
        }
        
        function updateWatchlistFilter() {
            // Clear existing watchlists
            const existingWatchlists = document.querySelectorAll('optgroup[data-type="watchlist"]');
            existingWatchlists.forEach(el => el.remove());
            
            // Add new watchlists
            if (watchlists.length > 0) {
                const watchlistGroup = document.createElement('optgroup');
                watchlistGroup.label = "Watchlists";
                watchlistGroup.dataset.type = "watchlist";
                
                watchlists.forEach(watchlist => {
                    const option = document.createElement('option');
                    option.value = watchlist.name;
                    option.textContent = watchlist.name;
                    watchlistGroup.appendChild(option);
                });
                
                symbolFilter.insertBefore(watchlistGroup, symbolFilter.querySelector('optgroup'));
            }
        }
        
        function renderWatchlists() {
            watchlistContainer.innerHTML = '';
            
            if (watchlists.length === 0) {
                watchlistContainer.innerHTML = '<p class="text-muted-2">No watchlists created yet</p>';
                return;
            }
            
            watchlists.forEach((watchlist, index) => {
                const card = document.createElement('div');
                card.className = 'watchlist-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>${watchlist.name}</h6>
                        <div class="watchlist-actions">
                            <button class="btn btn-sm btn-outline-primary edit-watchlist" data-index="${index}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-watchlist" data-index="${index}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="symbols-container mt-2">
                        ${watchlist.symbols.map(symbol => 
                            `<span class="symbol-badge">${symbol}</span>`
                        ).join('')}
                        ${watchlist.symbols.length === 0 ? '<span class="text-muted-2">No symbols</span>' : ''}
                    </div>
                `;
                watchlistContainer.appendChild(card);
                
                // Add event listeners to buttons
                card.querySelector('.edit-watchlist').addEventListener('click', () => editWatchlist(index));
                card.querySelector('.delete-watchlist').addEventListener('click', () => deleteWatchlist(index));
            });
        }
        
        function editWatchlist(index) {
            currentEditingWatchlist = index;
            const watchlist = watchlists[index];
            editWatchlistName.textContent = watchlist.name;
            renderCurrentSymbols();
            editWatchlistSection.style.display = 'block';
        }
        
        function renderCurrentSymbols() {
            if (currentEditingWatchlist === null) return;
            
            const watchlist = watchlists[currentEditingWatchlist];
            currentSymbols.innerHTML = '';
            
            watchlist.symbols.forEach(symbol => {
                const badge = document.createElement('div');
                badge.className = 'symbol-badge';
                badge.innerHTML = `
                    ${symbol}
                    <span class="remove-symbol" data-symbol="${symbol}">&times;</span>
                `;
                currentSymbols.appendChild(badge);
                
                badge.querySelector('.remove-symbol').addEventListener('click', function() {
                    const symbolToRemove = this.dataset.symbol;
                    const index = watchlist.symbols.indexOf(symbolToRemove);
                    if (index !== -1) {
                        watchlist.symbols.splice(index, 1);
                        renderCurrentSymbols();
                    }
                });
            });
        }
        
        function deleteWatchlist(index) {
            if (confirm(`Delete watchlist "${watchlists[index].name}"?`)) {
                watchlists.splice(index, 1);
                saveWatchlists();
                renderWatchlists();
                updateWatchlistFilter();
                
                // If deleted watchlist was selected, reset filter
                if (symbolFilter.value === watchlists[index]?.name) {
                    symbolFilter.value = '';
                    filterStocks();
                }
            }
        }
        
        function cancelEdit() {
            editWatchlistSection.style.display = 'none';
            currentEditingWatchlist = null;
        }
        
        // Portfolio symbols from backend
        const portfolioSymbols = {{ portfolio_symbols|tojson }};

        function filterStocks() {
            const selectedValue = symbolFilter.value;
            const rows = document.querySelectorAll('#stockTableBody tr');

            // Check if it's a watchlist
            const watchlist = watchlists.find(w => w.name === selectedValue);

            rows.forEach(row => {
                const symbol = row.dataset.symbol;

                if (selectedValue === '') {
                    row.style.display = '';
                } else if (selectedValue === '__MY_PORTFOLIO__') {
                    // Show only symbols in user's portfolio
                    row.style.display = portfolioSymbols.includes(symbol) ? '' : 'none';
                } else if (watchlist) {
                    // Show only symbols in the selected watchlist
                    row.style.display = watchlist.symbols.includes(symbol) ? '' : 'none';
                } else {
                    // Show only the selected symbol
                    row.style.display = symbol === selectedValue ? '' : 'none';
                }
            });
            
            // Reapply sorting if needed
            if (currentSort.column) {
                sortTable();
            }
        }
        
        function sortTable() {
            const visibleRows = Array.from(stockTableBody.querySelectorAll('tr:not([style*="display: none"])'));
            
            visibleRows.sort((a, b) => {
                const aValue = a.dataset[currentSort.column];
                const bValue = b.dataset[currentSort.column];
                
                if (currentSort.column === 'change') {
                    const aNum = parseFloat(aValue) || 0;
                    const bNum = parseFloat(bValue) || 0;
                    return (aNum - bNum) * currentSort.direction;
                } else {
                    return aValue.localeCompare(bValue) * currentSort.direction;
                }
            });
            
            // Reattach sorted rows
            visibleRows.forEach(row => stockTableBody.appendChild(row));
        }
    });
</script>
{% endblock %}