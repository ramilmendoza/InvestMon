<!-- templates/index.html -->
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1>Stock Dashboard</h1>
    </div>
    <div class="col-md-6 text-end">
        <form class="d-flex" id="filterForm">
            <select class="form-select me-2" id="symbolFilter" name="symbol">
                <option value="">All Symbols</option>
                {% for symbol in symbols %}
                    <option value="{{ symbol }}" {% if request.args.get('symbol') == symbol %}selected{% endif %}>
                        {{ symbol }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-dark" id="stockTable">
        <thead>
            <tr>
                <th class="sortable" data-sort="symbol">Symbol <span class="sort-icon">↕</span></th>
                <th>Date</th>
                <th>Last Price</th>
                <th class="sortable" data-sort="change">Change <span class="sort-icon">↕</span></th>
                <th>Volume</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="stockTableBody">
            {% for stock in stocks %}
                {% set change = ((stock.close - stock.open) / stock.open * 100) if stock.open and stock.close else 0 %}
                <tr data-symbol="{{ stock.symbol }}" data-change="{{ change }}">
                    <td class="fw-bold">{{ stock.symbol }}</td>
                    <td>{{ stock.date }}</td>
                    <td class="fw-medium">{{ "%.2f"|format(stock.close) if stock.close else '-' }}</td>
                    <td class="fw-bold {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-secondary{% endif %}">
                        {% if stock.open and stock.close %}
                            {{ "%+.2f"|format(change) }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ "{:,.0f}".format(stock.volume) if stock.volume else '-' }}</td>
                    <td>{{ "%.2f"|format(stock.open) if stock.open else '-' }}</td>
                    <td>{{ "%.2f"|format(stock.high) if stock.high else '-' }}</td>
                    <td>{{ "%.2f"|format(stock.low) if stock.low else '-' }}</td>
                    <td>
                        <a href="/symbol/{{ stock.symbol }}" class="btn btn-sm btn-primary">View</a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    .table-dark {
        background-color: #212529;
        color: #f8f9fa;
    }
    .table-dark th {
        background-color: #343a40;
        color: #fff;
    }
    .table-dark tr:hover {
        background-color: #2c3034;
    }
    .text-success {
        color: #20c997 !important;
    }
    .text-danger {
        color: #ff6b6b !important;
    }
    .fw-medium {
        font-weight: 500;
    }
    .sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
    }
    .sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .sort-icon {
        margin-left: 5px;
        font-size: 0.8em;
    }
    .sort-asc .sort-icon::after {
        content: " ↑";
    }
    .sort-desc .sort-icon::after {
        content: " ↓";
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('stockTable');
        const tbody = document.getElementById('stockTableBody');
        const filterForm = document.getElementById('filterForm');
        const symbolFilter = document.getElementById('symbolFilter');
        const sortableHeaders = document.querySelectorAll('.sortable');
        
        let currentSort = {
            column: null,
            direction: 1 // 1 for ascending, -1 for descending
        };
        
        // Initialize from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('symbol')) {
            symbolFilter.value = urlParams.get('symbol');
            filterStocks();
        }
        
        // Filter functionality
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const params = new URLSearchParams();
            if (symbolFilter.value) {
                params.set('symbol', symbolFilter.value);
            }
            window.history.pushState({}, '', '?' + params.toString());
            filterStocks();
        });
        
        // Also filter when dropdown changes (without requiring submit button)
        symbolFilter.addEventListener('change', function() {
            const params = new URLSearchParams();
            if (this.value) {
                params.set('symbol', this.value);
            }
            window.history.pushState({}, '', '?' + params.toString());
            filterStocks();
        });
        
        function filterStocks() {
            const filterValue = symbolFilter.value.toLowerCase();
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const symbol = row.dataset.symbol.toLowerCase();
                if (filterValue === '' || symbol === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Reapply sorting after filtering
            if (currentSort.column) {
                sortTable();
            }
        }
        
        // Sort functionality
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortColumn = this.dataset.sort;
                
                // Update sort direction if clicking the same column
                if (currentSort.column === sortColumn) {
                    currentSort.direction *= -1;
                } else {
                    currentSort.column = sortColumn;
                    currentSort.direction = 1;
                }
                
                // Update sort indicators
                sortableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(currentSort.direction === 1 ? 'sort-asc' : 'sort-desc');
                
                // Sort the table
                sortTable();
            });
        });
        
        function sortTable() {
            const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
            
            rows.sort((a, b) => {
                const aValue = a.dataset[currentSort.column];
                const bValue = b.dataset[currentSort.column];
                
                // Numeric comparison for change, string for symbol
                if (currentSort.column === 'change') {
                    const aNum = parseFloat(aValue) || 0;
                    const bNum = parseFloat(bValue) || 0;
                    return (aNum - bNum) * currentSort.direction;
                } else {
                    return aValue.localeCompare(bValue) * currentSort.direction;
                }
            });
            
            // Reattach sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
    });
</script>
{% endblock %}